<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Profile - Suhaim Tailoring</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/form.css" />
    <link rel="stylesheet" href="css/receipt.css" />
    <link rel="stylesheet" href="css/responsive.css" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@400;600;700&family=Noto+Sans+Bengali:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer"
    />

    <!-- QR Code Library -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
      integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <style>
      /* Customer Profile Specific Styles */
      .profile-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .search-header {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
        text-align: center;
      }

      .search-box-container {
        max-width: 600px;
        margin: 2rem auto;
      }

      .search-input-group {
        display: flex;
        gap: 1rem;
      }

      .search-input-group input {
        flex: 1;
      }

      .customer-profile-card {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .customer-profile-card.show {
        display: block;
      }

      .profile-overview {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
      }

      .profile-header-info {
        display: flex;
        flex-wrap: wrap;
        flex-direction: column;
      }

      .customer-details {
        flex: 1;
        padding-bottom: 25px;
        align-items: center;
        justify-items: center;
      }

      .customer-avatar {
        width: 80px;
        height: 80px;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }

      .customer-name {
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
      }

      .customer-info-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray-600);
        margin-bottom: 0.5rem;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(30px, 1fr));
        gap: 1rem;
      }

      .stat-card {
        background: var(--gray-50);
        padding: 1.5rem;
        border-radius: 0.75rem;
        text-align: center;
        border: 2px solid transparent;
        transition: all var(--transition-base);
      }

      .stat-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .profile-tabs {
        background: white;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
      }

      .tab-button {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        color: var(--gray-600);
        cursor: pointer;
        transition: all var(--transition-base);
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .tab-button.active {
        background: var(--primary-color);
        color: white;
      }

      .tab-button:hover:not(.active) {
        background: var(--gray-100);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      .measurements-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
      }

      .measurements-display-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .measurement-card {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.75rem;
        border-left: 4px solid var(--primary-color);
        transition: all var(--transition-base);
      }

      .measurement-card:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-md);
      }

      .measurement-label {
        font-size: 0.75rem;
        color: var(--primary-color);
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-bottom: 0.5rem;
        width: 500px;
        font-weight: bolder;
      }

      .measurement-value {
        display: flex;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--gray-900);
        align-items: center;
      }

      .measurement-unit {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-left: 0.25rem;
      }

      .orders-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
      }

      .orders-table {
        width: 100%;
        margin-top: 1.5rem;
      }

      .orders-table thead {
        background: var(--gray-50);
      }

      .orders-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .orders-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .orders-table tbody tr:hover {
        background: var(--gray-50);
      }

      .order-status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-new {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
      }

      .status-progress {
        background: rgba(251, 146, 60, 0.1);
        color: #fb923c;
      }

      .status-ready {
        background: rgba(250, 204, 21, 0.1);
        color: #facc15;
      }

      .status-delivered {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
      }

      .status-cancelled {
        background: rgba(107, 114, 128, 0.1);
        color: #6b7280;
      }

      .action-buttons-group {
        display: flex;
        gap: 0.5rem;
      }

      .action-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-base);
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .action-btn-view {
        background: var(--primary-color);
        color: white;
      }

      .action-btn-view:hover {
        background: var(--primary-dark);
      }

      .action-btn-print {
        background: var(--gray-200);
        color: var(--gray-700);
      }

      .action-btn-print:hover {
        background: var(--gray-300);
      }

      .action-btn-update {
        background: var(--success-color);
        color: white;
      }

      .action-btn-update:hover {
        background: var(--secondary-dark);
      }

      .action-btn-payment {
        background: #f59e0b;
        color: white;
      }

      .action-btn-payment:hover {
        background: #d97706;
      }

      .quick-actions-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .quick-action-card {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-base);
        text-decoration: none;
        color: var(--gray-900);
      }

      .quick-action-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .quick-action-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(
          135deg,
          var(--primary-light),
          var(--primary-color)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 1.5rem;
      }

      .quick-action-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .quick-action-desc {
        font-size: 0.875rem;
        color: var(--gray-600);
      }

      .no-data-message {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-500);
      }

      .no-data-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .status-update-modal,
      .payment-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      .status-update-modal.show,
      .payment-modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        max-width: fit-content;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray-500);
      }

      .status-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 1.5rem 0;
      }

      .status-option {
        padding: 1rem;
        border: 2px solid var(--gray-200);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .status-option:hover {
        border-color: var(--primary-color);
        background: var(--gray-50);
      }

      .status-option.selected {
        border-color: var(--primary-color);
        background: rgba(37, 99, 235, 0.05);
      }

      .payment-info {
        background: var(--gray-50);
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
      }

      .payment-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
      }

      .payment-info-row:last-child {
        margin-bottom: 0;
        padding-top: 0.75rem;
        border-top: 2px solid var(--gray-200);
        font-weight: bold;
        font-size: 1.125rem;
      }

      .payment-input-group {
        margin-bottom: 1.5rem;
      }

      .payment-input-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--gray-700);
      }

      .payment-input-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--gray-200);
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all var(--transition-base);
      }

      .payment-input-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .payment-input-group .input-help {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
      }

      .payment-input-group .input-error {
        font-size: 0.875rem;
        color: #ef4444;
        margin-top: 0.25rem;
      }

      /* Receipt Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .receipt-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
        padding: 0 1rem;
      }

      .receipt-actions button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-success {
        background: var(--success-color);
        color: white;
      }

      .btn-success:hover {
        background: var(--success-dark);
      }

      .btn-secondary {
        background: var(--gray-200);
        color: var(--gray-700);
      }

      .btn-secondary:hover {
        background: var(--gray-300);
      }

      @media (max-width: 768px) {
        .profile-header-info {
          flex-direction: column;
          text-align: center;
        }

        .customer-avatar {
          margin: 0 auto 1rem;
        }

        .stats-container {
          grid-template-columns: repeat(2, 1fr);
        }

        .orders-table {
          font-size: 0.875rem;
        }

        .action-buttons-group {
          flex-direction: column;
        }

        .quick-actions-section {
          grid-template-columns: 1fr;
        }
      }

      /* Updated Print Styles - FIXED FOR SINGLE PAGE */
      /* Updated Print Styles - FIXED FOR SINGLE PAGE */
      @media print {
        @page {
          size: A4;
          margin: 10mm;
        }

        /* Hide everything except the receipt */
        body * {
          visibility: hidden !important;
          height: 0 !important;
          overflow: hidden !important;
        }

        /* Show only the receipt and its contents */
        #receipt,
        #receipt * {
          visibility: visible !important;
          height: auto !important;
          overflow: visible !important;
        }

        /* Position the receipt properly for printing */
        #receipt {
          position: fixed !important;
          left: 0 !important;
          top: 0 !important;
          width: 100% !important;
          height: auto !important;
          background: white !important;
          margin: 0 !important;
          padding: 0 !important;
          z-index: 999999 !important;
        }

        /* Ensure single page - scale down more aggressively if needed */
        .modern-receipt-container {
          transform: scale(0.9) !important; /* Reduced from 0.9 to 0.7 */
          transform-origin: top left !important;
          width: 100% !important; /* Compensate for scale */
          max-width: none !important;
          page-break-inside: avoid !important;
          page-break-after: avoid !important;
          page-break-before: avoid !important;
          max-height: auto !important; /* Constrain height */
          overflow: hidden !important;
        }

        /* Hide modal background and actions during print */
        .modal {
          background: transparent !important;
          position: static !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        .modal-content {
          padding: 0 !important;
          margin: 0 !important;
          box-shadow: none !important;
        }

        .receipt-actions {
          display: none !important;
        }

        /* Prevent page breaks in all receipt elements */
        #receipt,
        #receipt *,
        .modern-receipt-wrapper,
        .modern-receipt-wrapper *,
        .modern-receipt-container,
        .modern-receipt-container * {
          page-break-inside: avoid !important;
          page-break-after: avoid !important;
          page-break-before: avoid !important;
        }

        /* Adjust font sizes for better fit */
        .modern-receipt-container {
          font-size: 11px !important; /* Reduced from 11px */
        }

        .brand-name {
          font-size: 20px !important; /* Reduced from 20px */
        }

        .section-heading {
          font-size: 12px !important; /* Reduced from 12px */
        }

        /* Compact spacing more aggressively */
        .data-section {
          margin-bottom: 10px !important; /* Reduced */
          padding: 8px !important; /* Reduced */
        }

        .payment-box {
          padding: 10px !important; /* Reduced */
        }

        .modern-footer {
          margin-top: 10px !important; /* Reduced */
          padding-top: 10px !important; /* Reduced */
        }

        /* Remove any unnecessary spacing */
        .qr-section {
          padding: 8px !important;
          margin: 8px 0 !important;
        }

        /* Ensure measurements section doesn't break */
        .measurements-group {
          page-break-inside: avoid !important;
        }

        /* Force single column for measurements if needed */
        .measurements-grid {
          grid-template-columns: repeat(
            4,
            1fr
          ) !important; /* Keep 4 columns but smaller */
        }

        /* Hide any overflow content */
        body {
          overflow: hidden !important;
        }
      }

      /* Additional class for when printing measurements specifically */
      @media print {
        body.printing-measurements * {
          visibility: hidden !important;
        }

        body.printing-measurements #measurementsPrintWrapper,
        body.printing-measurements #measurementsPrintWrapper * {
          visibility: visible !important;
        }

        body.printing-measurements #measurementsModal {
          position: fixed !important;
          left: 0 !important;
          top: 0 !important;
          background: white !important;
        }
      }

      /* Make sure measurements wrapper is visible in modal */
      .measurements-print-wrapper {
        display: block !important;
      }
    </style>
  <link rel="stylesheet" href="css/icon-fallback.css">
</head>
  <body>
    <!-- Language Selector -->
    <div class="language-selector">
      <select id="languageSelect" onchange="changeLanguage(this.value)">
        <option value="en">🇬🇧 English</option>
        <option value="ar">🇸🇦 العربية</option>
        <option value="bn">🇧🇩 বাংলা</option>
      </select>
    </div>

    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">
      <a href="index.html" class="action-link">
        <i class="fas fa-home"></i>
        <span data-lang="home">Home</span>
      </a>
      <a href="order-status.html" class="action-link">
        <i class="fas fa-truck"></i>
        <span data-lang="trackOrder">Track Order</span>
      </a>
      <a href="#" class="action-link" onclick="openWhatsApp()">
        <i class="fab fa-whatsapp"></i>
        <span data-lang="whatsappSupport">WhatsApp</span>
      </a>
    </div>

    <div class="container profile-container">
      <!-- Search Header -->
      <div class="search-header">
        <h1>
          <i class="fas fa-users"></i>
          <span data-lang="customerProfile">Customer Profile</span>
        </h1>
        <p data-lang="searchDescription"
          >Search customers by phone number to view their profile and order
          history</p
        >

        <div class="search-box-container">
          <div class="search-input-group">
            <input
              type="tel"
              id="searchPhone"
              class="form-control"
              placeholder="Enter phone number (e.g., 0501234567)"
              data-placeholder-key="enterPhoneNumber"
            />
            <button class="btn-primary" onclick="performCustomerSearch()">
              <i class="fas fa-search"></i>
              <span data-lang="search">Search</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Customer Profile Card -->
      <div class="customer-profile-card" id="customerProfileCard">
        <!-- Profile Overview -->
        <div class="profile-overview">
          <div class="profile-header-info">
            <div class="customer-details">
              <div class="customer-avatar" id="customerAvatar">
                <i class="fas fa-user"></i>
              </div>
              <h2 class="customer-name" id="customerName">-</h2>
              <div class="customer-info-row">
                <i class="fas fa-phone"></i>
                <span id="customerPhone">-</span>
              </div>
              <div class="customer-info-row">
                <i class="fas fa-calendar"></i>
                <span data-lang="memberSince">Member since</span>
                <span id="memberSince">-</span>
              </div>
            </div>

            <div class="stats-container">
              <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label" data-lang="totalOrders"
                  >Total Orders</div
                >
              </div>
              <div class="stat-card">
                <div class="stat-value" id="totalSpent">0</div>
                <div class="stat-label" data-lang="totalSpent">Total (SAR)</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="pendingAmount">0</div>
                <div class="stat-label" data-lang="pendingAmount">Pending</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="completedOrders">0</div>
                <div class="stat-label" data-lang="completed">Completed</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Tabs -->
        <div class="profile-tabs">
          <button class="tab-button active" onclick="switchTab('measurements')">
            <i class="fas fa-ruler"></i>
            <span data-lang="measurements">Measurements</span>
          </button>
          <button class="tab-button" onclick="switchTab('orders')">
            <i class="fas fa-history"></i>
            <span data-lang="orderHistory">Order History</span>
          </button>
          <button class="tab-button" onclick="switchTab('preferences')">
            <i class="fas fa-cog"></i>
            <span data-lang="preferences">Preferences</span>
          </button>
        </div>

        <!-- Measurements Tab -->
        <div class="tab-content active" id="measurementsTab">
          <div class="measurements-section">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
              "
            >
              <h3>
                <i class="fas fa-ruler-combined"></i>
                <span data-lang="latestMeasurements">Latest Measurements</span>
              </h3>
              <button class="btn-secondary" onclick="printMeasurements()">
                <i class="fas fa-print"></i>
                <span data-lang="print">Print</span>
              </button>
            </div>

            <div class="measurements-display-grid">
              <div class="measurement-card">
                <div class="measurement-label" data-lang="length">Length</div>
                <div class="measurement-value">
                  <span id="m-length">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="shoulder"
                  >Shoulder</div
                >
                <div class="measurement-value">
                  <span id="m-shoulder">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="sleeveLength"
                  >Sleeve Length</div
                >
                <div class="measurement-value">
                  <span id="m-sleeveLength">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="sleeveWidth"
                  >Sleeve Width</div
                >
                <div class="measurement-value">
                  <span id="m-sleeveWidth">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="chestWidth"
                  >Chest Width</div
                >
                <div class="measurement-value">
                  <span id="m-chestWidth">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="neck">Neck</div>
                <div class="measurement-value">
                  <span id="m-neck">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="handWidth"
                  >Hand Width</div
                >
                <div class="measurement-value">
                  <span id="m-handWidth">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="cuffLength"
                  >Cuff Length</div
                >
                <div class="measurement-value">
                  <span id="m-cuffLength">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions-section">
              <a
                href="index.html"
                class="quick-action-card"
                onclick="useCustomerData()"
              >
                <div class="quick-action-icon">
                  <i class="fas fa-plus"></i>
                </div>
                <div class="quick-action-title" data-lang="newOrder"
                  >New Order</div
                >
                <div class="quick-action-desc" data-lang="useSavedMeasurements"
                  >Use saved measurements</div
                >
              </a>

              <div class="quick-action-card" onclick="exportCustomerData()">
                <div class="quick-action-icon">
                  <i class="fas fa-download"></i>
                </div>
                <div class="quick-action-title" data-lang="exportData"
                  >Export Data</div
                >
                <div class="quick-action-desc" data-lang="downloadCustomerInfo"
                  >Download customer information</div
                >
              </div>

              <div
                class="quick-action-card"
                onclick="sendMeasurementsWhatsApp()"
              >
                <div class="quick-action-icon">
                  <i class="fab fa-whatsapp"></i>
                </div>
                <div class="quick-action-title" data-lang="sendWhatsApp"
                  >Send WhatsApp</div
                >
                <div class="quick-action-desc" data-lang="shareMeasurements"
                  >Share measurements via WhatsApp</div
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content" id="ordersTab">
          <div class="orders-section">
            <h3>
              <i class="fas fa-shopping-bag"></i>
              <span data-lang="orderHistory">Order History</span>
            </h3>

            <table class="orders-table">
              <thead>
                <tr>
                  <th data-lang="orderNumber">Order #</th>
                  <th data-lang="date">Date</th>
                  <th data-lang="items">Items</th>
                  <th data-lang="total">Total</th>
                  <th data-lang="remaining">Remaining</th>
                  <th data-lang="status">Status</th>
                  <th data-lang="actions">Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <!-- Orders will be populated here -->
              </tbody>
            </table>

            <div
              class="no-data-message"
              id="noOrdersMessage"
              style="display: none"
            >
              <div class="no-data-icon">
                <i class="fas fa-inbox"></i>
              </div>
              <h3 data-lang="noOrders">No Orders Found</h3>
              <p data-lang="noOrdersDesc">This customer has no order history</p>
            </div>
          </div>
        </div>

        <!-- Preferences Tab -->
        <div class="tab-content" id="preferencesTab">
          <div class="measurements-section">
            <h3>
              <i class="fas fa-user-cog"></i>
              <span data-lang="customerPreferences">Customer Preferences</span>
            </h3>

            <div style="margin-top: 1.5rem">
              <h4
                style="margin-bottom: 1rem"
                data-lang="notificationPreferences"
                >Notification Preferences</h4
              >

              <div style="display: flex; flex-direction: column; gap: 1rem">
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 1rem;
                    background: var(--gray-50);
                    border-radius: 0.5rem;
                  "
                >
                  <input
                    type="checkbox"
                    id="prefSMS"
                    style="width: 20px; height: 20px"
                  />
                  <div>
                    <strong data-lang="smsNotifications"
                      >SMS Notifications</strong
                    >
                    <p
                      style="color: var(--gray-600); font-size: 0.875rem"
                      data-lang="smsDesc"
                      >Receive order updates via SMS</p
                    >
                  </div>
                </label>

                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 1rem;
                    background: var(--gray-50);
                    border-radius: 0.5rem;
                  "
                >
                  <input
                    type="checkbox"
                    id="prefWhatsApp"
                    checked
                    style="width: 20px; height: 20px"
                  />
                  <div>
                    <strong data-lang="whatsappNotifications"
                      >WhatsApp Notifications</strong
                    >
                    <p
                      style="color: var(--gray-600); font-size: 0.875rem"
                      data-lang="whatsappDesc"
                      >Receive order updates via WhatsApp</p
                    >
                  </div>
                </label>
              </div>

              <h4 style="margin: 2rem 0 1rem" data-lang="preferredDesigns"
                >Preferred Designs</h4
              >
              <div
                id="preferredDesigns"
                style="display: flex; flex-wrap: wrap; gap: 0.5rem"
              >
                <!-- Will be populated based on order history -->
              </div>

              <button
                class="btn-primary"
                style="margin-top: 2rem"
                onclick="savePreferences()"
              >
                <i class="fas fa-save"></i>
                <span data-lang="savePreferences">Save Preferences</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Update Modal -->
    <div class="status-update-modal" id="statusUpdateModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" data-lang="updateOrderStatus"
            >Update Order Status</h2
          >
          <button class="modal-close" onclick="closeStatusModal()">×</button>
        </div>

        <div style="margin-bottom: 1rem">
          <strong data-lang="orderNumber">Order Number</strong>:
          <span id="modalOrderNumber">-</span>
        </div>

        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="New" />
            <span data-lang="statusNew">New</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="In Progress" />
            <span data-lang="statusProgress">In Progress</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="Ready" />
            <span data-lang="statusReady">Ready</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="Delivered" />
            <span data-lang="statusDelivered">Delivered</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="Cancelled" />
            <span data-lang="statusCancelled">Cancelled</span>
          </label>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end">
          <button class="btn-secondary" onclick="closeStatusModal()">
            <span data-lang="cancel">Cancel</span>
          </button>
          <button class="btn-primary" onclick="performStatusUpdate()">
            <i class="fas fa-check"></i>
            <span data-lang="update">Update</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Payment Modal -->
    <div class="payment-modal" id="paymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" data-lang="updatePayment">Update Payment</h2>
          <button class="modal-close" onclick="closePaymentModal()">×</button>
        </div>

        <div class="payment-info">
          <div class="payment-info-row">
            <span data-lang="orderNumber">Order Number</span>
            <span id="paymentOrderNumber">-</span>
          </div>
          <div class="payment-info-row">
            <span data-lang="customerName">Customer</span>
            <span id="paymentCustomerName">-</span>
          </div>
          <div class="payment-info-row">
            <span data-lang="totalAmount">Total Amount</span>
            <span id="paymentTotalAmount">0</span>
          </div>
          <div class="payment-info-row">
            <span data-lang="paidAmount">Already Paid</span>
            <span id="paymentPaidAmount">0</span>
          </div>
          <div class="payment-info-row">
            <span data-lang="remainingAmount">Remaining Amount</span>
            <span id="paymentRemainingAmount" style="color: #ef4444">0</span>
          </div>
        </div>

        <div class="payment-input-group">
          <label for="newPaymentAmount" data-lang="enterPaymentAmount"
            >Enter Payment Amount</label
          >
          <input
            type="number"
            id="newPaymentAmount"
            placeholder="Enter amount to pay"
            min="0"
            step="0.01"
            onkeyup="validatePaymentAmount()"
            oninput="validatePaymentAmount()"
          />
          <div class="input-help" id="paymentHelp" data-lang="paymentHelp"
            >Enter amount to pay (cannot exceed remaining amount)</div
          >
          <div
            class="input-error"
            id="paymentError"
            style="display: none"
          ></div>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end">
          <button class="btn-secondary" onclick="closePaymentModal()">
            <span data-lang="cancel">Cancel</span>
          </button>
          <button
            class="btn-primary"
            id="updatePaymentBtn"
            onclick="performPaymentUpdate()"
            disabled
          >
            <i class="fas fa-money-bill"></i>
            <span data-lang="updatePayment">Update Payment</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
      <div class="modal-content">
        <div class="receipt" id="receipt">
          <!-- Receipt content will be generated dynamically -->
        </div>
        <div class="receipt-actions">
          <button class="btn-primary" onclick="printReceipt()">
            <i class="fas fa-print"></i> <span data-lang="print">Print</span>
          </button>
          <button class="btn-success" onclick="sendWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            <span data-lang="sendWhatsApp">Send WhatsApp</span>
          </button>
          <button class="btn-secondary" onclick="closeReceiptModal()">
            <i class="fas fa-times"></i>
            <span data-lang="close">Close</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Measurements Modal (Hidden by default) -->
    <div id="measurementsModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="measurements-print-wrapper" id="measurementsPrintWrapper">
          <!-- Measurements content will be generated dynamically -->
        </div>
        <div class="receipt-actions">
          <button class="btn-primary" onclick="printMeasurementsNow()">
            <i class="fas fa-print"></i> <span data-lang="print">Print</span>
          </button>
          <button class="btn-secondary" onclick="closeMeasurementsModal()">
            <i class="fas fa-times"></i>
            <span data-lang="close">Close</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="js/language.js"></script>
    <script src="js/api.js"></script>
    <script src="js/receipt.js"></script>

    <script>
      let currentLang = "en";
      let currentCustomerData = null;
      let customerOrders = [];
      let currentUpdateOrder = null;
      let currentViewOrder = null;
      let currentPaymentOrder = null;
      let originalTitle = document.title; // Store original title

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        // Set language
        const savedLang = localStorage.getItem("preferredLanguage") || "en";
        changeLanguage(savedLang);

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const phone = urlParams.get("phone");
        if (phone) {
          document.getElementById("searchPhone").value = phone;
          performCustomerSearch();
        }

        // Handle Enter key in search
        document
          .getElementById("searchPhone")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              performCustomerSearch();
            }
          });
      });

      // Search customer - renamed to avoid conflict
      async function performCustomerSearch() {
        const phoneNumber = document.getElementById("searchPhone").value.trim();

        if (!phoneNumber) {
          showNotification("Please enter a phone number", "warning");
          return;
        }

        showNotification("Searching...", "info");

        try {
          // Check if the searchCustomer function exists
          if (typeof searchCustomer !== "function") {
            console.error(
              "searchCustomer function not found. Make sure api.js is loaded properly."
            );
            showNotification(
              "System error. Please refresh and try again.",
              "error"
            );
            return;
          }

          // Call the API searchCustomer function
          const response = await searchCustomer(phoneNumber);

          if (response && response.status === "success" && response.customer) {
            displayCustomerProfile(response.customer, response.orders || []);
            document
              .getElementById("customerProfileCard")
              .classList.add("show");
            showNotification("Customer found!", "success");
          } else {
            showNotification(
              "No customer found with this phone number",
              "error"
            );
            document
              .getElementById("customerProfileCard")
              .classList.remove("show");
          }
        } catch (error) {
          console.error("Error searching customer:", error);
          showNotification(
            "Error searching customer. Please try again.",
            "error"
          );
        }
      }

      // Display customer profile
      function displayCustomerProfile(customer, orders) {
        currentCustomerData = customer;
        customerOrders = orders;

        // Update avatar with initials
        const initials = customer.name
          ? customer.name
              .split(" ")
              .map((n) => n[0])
              .join("")
              .toUpperCase()
          : "?";
        document.getElementById("customerAvatar").textContent = initials;

        // Update customer details
        document.getElementById("customerName").textContent =
          customer.name || "Unknown";
        document.getElementById("customerPhone").textContent =
          "+966" + (customer.phone || "");
        document.getElementById("memberSince").textContent = formatDate(
          customer.firstOrderDate
        );

        // Calculate statistics
        let totalAmount = 0;
        let pendingAmount = 0;
        let completedOrders = 0;

        orders.forEach((order) => {
          totalAmount += parseFloat(order.totalAmount) || 0;
          pendingAmount += parseFloat(order.remainingAmount) || 0;

          const status = order.status?.toLowerCase() || "";
          if (status.includes("delivered") || status.includes("تسليم")) {
            completedOrders++;
          }
        });

        // Update statistics
        document.getElementById("totalOrders").textContent = orders.length;
        document.getElementById("totalSpent").textContent =
          totalAmount.toFixed(0);
        document.getElementById("pendingAmount").textContent =
          pendingAmount.toFixed(0);
        document.getElementById("completedOrders").textContent =
          completedOrders;

        // Update measurements (from latest order)
        if (orders.length > 0) {
          const latestOrder = orders[0];
          updateMeasurements(latestOrder);

          // Extract preferred designs
          extractPreferredDesigns(orders);
        } else {
          // Clear measurements if no orders
          updateMeasurements({});
        }

        // Populate orders table
        populateOrdersTable(orders);

        // Load preferences
        loadCustomerPreferences(customer.phone);
      }

      // Update measurements display
      function updateMeasurements(order) {
        const measurements = [
          "length",
          "shoulder",
          "sleeveLength",
          "sleeveWidth",
          "chestWidth",
          "neck",
          "handWidth",
          "cuffLength",
        ];

        measurements.forEach((measurement) => {
          const value = order[measurement];
          const element = document.getElementById(`m-${measurement}`);
          if (element) {
            element.textContent = value && value !== "-" ? value : "-";
          }
        });
      }

      // Populate orders table
      function populateOrdersTable(orders) {
        const tbody = document.getElementById("ordersTableBody");
        tbody.innerHTML = "";

        if (orders.length === 0) {
          document.getElementById("noOrdersMessage").style.display = "block";
          document.querySelector(".orders-table").style.display = "none";
          return;
        }

        document.getElementById("noOrdersMessage").style.display = "none";
        document.querySelector(".orders-table").style.display = "table";

        orders.forEach((order) => {
          const row = document.createElement("tr");

          const statusClass = getStatusClass(order.status);
          const remainingAmount = parseFloat(order.remainingAmount) || 0;

          // Store order data as JSON string in data attribute
          row.setAttribute("data-order", JSON.stringify(order));

          row.innerHTML = `
                    <td>${order.orderNumber || "-"}</td>
                    <td>${formatDate(order.orderDate)}</td>
                    <td>${order.thobeCount || 1}</td>
                    <td>${order.totalAmount || "0"} ${getCurrency()}</td>
                    <td style="color: ${
                      remainingAmount > 0 ? "#ef4444" : "#22c55e"
                    }; font-weight: bold;">
                      ${remainingAmount.toFixed(2)} ${getCurrency()}
                    </td>
                    <td><span class="order-status-badge ${statusClass}">${
            order.status || "New"
          }</span></td>
                    <td>
                        <div class="action-buttons-group">
                            <button class="action-btn action-btn-view" onclick='viewOrder(${JSON.stringify(
                              order
                            ).replace(/'/g, "&apos;")})'>
                                <i class="fas fa-eye"></i>
                                <span>View</span>
                            </button>
                            <button class="action-btn action-btn-print" onclick='printOrder(${JSON.stringify(
                              order
                            ).replace(/'/g, "&apos;")})'>
                                <i class="fas fa-print"></i>
                            </button>
                            ${
                              remainingAmount > 0
                                ? `
                            <button class="action-btn action-btn-payment" onclick='openPaymentModal(${JSON.stringify(
                              order
                            ).replace(/'/g, "&apos;")})'>
                                <i class="fas fa-money-bill"></i>
                                <span>Payment</span>
                            </button>`
                                : ""
                            }
                            <button class="action-btn action-btn-update" onclick="openStatusModal('${
                              order.receiptId
                            }', '${order.orderNumber}', '${
            order.status || "New"
          }')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;

          tbody.appendChild(row);
        });
      }

      // Open payment modal
      function openPaymentModal(order) {
        currentPaymentOrder = order;

        // Update modal with order details
        document.getElementById("paymentOrderNumber").textContent =
          order.orderNumber || "-";
        document.getElementById("paymentCustomerName").textContent =
          order.customerName || "-";
        document.getElementById("paymentTotalAmount").textContent = `${
          order.totalAmount || 0
        } ${getCurrency()}`;
        document.getElementById("paymentPaidAmount").textContent = `${
          order.paidAmount || 0
        } ${getCurrency()}`;

        const remaining = parseFloat(order.remainingAmount) || 0;
        document.getElementById(
          "paymentRemainingAmount"
        ).textContent = `${remaining.toFixed(2)} ${getCurrency()}`;

        // Reset input
        document.getElementById("newPaymentAmount").value = "";
        document.getElementById("newPaymentAmount").max = remaining;
        document.getElementById("paymentError").style.display = "none";
        document.getElementById("updatePaymentBtn").disabled = true;

        // Show modal
        document.getElementById("paymentModal").classList.add("show");
      }

      // Close payment modal
      function closePaymentModal() {
        document.getElementById("paymentModal").classList.remove("show");
        currentPaymentOrder = null;
      }

      // Validate payment amount
      function validatePaymentAmount() {
        const input = document.getElementById("newPaymentAmount");
        const errorDiv = document.getElementById("paymentError");
        const updateBtn = document.getElementById("updatePaymentBtn");

        const amount = parseFloat(input.value) || 0;
        const remaining = parseFloat(currentPaymentOrder?.remainingAmount) || 0;

        if (amount <= 0) {
          errorDiv.textContent = "Please enter a valid amount";
          errorDiv.style.display = "block";
          updateBtn.disabled = true;
        } else if (amount > remaining) {
          errorDiv.textContent = `Amount cannot exceed ${remaining.toFixed(
            2
          )} ${getCurrency()}`;
          errorDiv.style.display = "block";
          updateBtn.disabled = true;
        } else {
          errorDiv.style.display = "none";
          updateBtn.disabled = false;
        }
      }

      // Update payment
      async function performPaymentUpdate() {
        if (!currentPaymentOrder) return;

        const amount =
          parseFloat(document.getElementById("newPaymentAmount").value) || 0;
        if (amount <= 0) {
          showNotification("Please enter a valid amount", "warning");
          return;
        }

        try {
          showNotification("Updating payment...", "info");

          // Check if updatePayment function exists
          if (typeof updatePayment !== "function") {
            console.error("updatePayment function not found");
            showNotification(
              "System error. Please refresh and try again.",
              "error"
            );
            return;
          }

          // Update payment in database
          const response = await updatePayment(
            currentPaymentOrder.receiptId,
            amount
          );

          if (response && response.status === "success") {
            showNotification("Payment updated successfully", "success");

            // Update the order in our local data
            const orderIndex = customerOrders.findIndex(
              (o) => o.receiptId === currentPaymentOrder.receiptId
            );
            if (orderIndex !== -1) {
              customerOrders[orderIndex].paidAmount =
                parseFloat(customerOrders[orderIndex].paidAmount || 0) + amount;
              customerOrders[orderIndex].remainingAmount =
                parseFloat(customerOrders[orderIndex].remainingAmount || 0) -
                amount;

              // Refresh the display
              populateOrdersTable(customerOrders);

              // Update statistics
              displayCustomerProfile(currentCustomerData, customerOrders);
            }

            closePaymentModal();
          } else {
            showNotification("Error updating payment", "error");
          }
        } catch (error) {
          console.error("Error updating payment:", error);
          showNotification("Error updating payment", "error");
        }
      }

      // Get status class
      function getStatusClass(status) {
        if (!status) return "status-new";
        const statusLower = status.toLowerCase();

        if (statusLower.includes("progress") || statusLower.includes("قيد"))
          return "status-progress";
        if (statusLower.includes("ready") || statusLower.includes("جاهز"))
          return "status-ready";
        if (statusLower.includes("delivered") || statusLower.includes("تسليم"))
          return "status-delivered";
        if (statusLower.includes("cancelled") || statusLower.includes("ملغى"))
          return "status-cancelled";
        return "status-new";
      }

      // Switch tabs
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.closest(".tab-button").classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`${tabName}Tab`).classList.add("active");
      }

      // View order - Updated to show modal with receipt
      function viewOrder(orderData) {
        currentViewOrder = orderData;

        // Generate receipt using the same function from receipt.js
        if (typeof generateReceipt === "function") {
          generateReceipt(orderData);
          // Show the modal
          document.getElementById("receiptModal").classList.add("show");
        } else {
          console.error("generateReceipt function not found");
          showNotification("Error loading receipt", "error");
        }
      }

      // Print order - Fixed to properly render receipt before printing
      // Print order - Fixed to properly render receipt before printing
      function printOrder(orderData) {
        currentViewOrder = orderData;

        // Generate receipt
        if (typeof generateReceipt === "function") {
          // First, generate the receipt
          generateReceipt(orderData);

          // Show the modal (needed for receipt to be in DOM)
          document.getElementById("receiptModal").classList.add("show");

          // Set document title to order number for PDF filename
          const orderNumber = orderData.orderNumber || "Receipt";
          document.title = orderNumber;

          // Add a class to body for print mode
          document.body.classList.add("printing-receipt");

          // Wait for receipt to fully render, then print
          setTimeout(() => {
            window.print();
            // Restore original title and clean up after printing
            setTimeout(() => {
              document.title = originalTitle;
              document.getElementById("receiptModal").classList.remove("show");
              document.body.classList.remove("printing-receipt");
            }, 500);
          }, 800); // Increased timeout for better rendering
        } else {
          console.error("generateReceipt function not found");
          showNotification("Error loading receipt", "error");
        }
      }
      // Print receipt from modal - FIXED for single page and filename
      function printReceipt() {
        if (currentViewOrder) {
          // Set document title to order number for PDF filename
          const orderNumber = currentViewOrder.orderNumber || "Receipt";
          document.title = orderNumber;
        }

        // Small delay to ensure receipt is fully rendered
        setTimeout(() => {
          window.print();
          // Restore original title after printing
          setTimeout(() => {
            document.title = originalTitle;
          }, 100);
        }, 100);
      }

      // Send WhatsApp from receipt modal
      function sendWhatsApp() {
        if (!currentViewOrder) return;

        const message =
          `Hello! Here are your order details:\n\n` +
          `Order #: ${currentViewOrder.orderNumber}\n` +
          `Receipt #: ${currentViewOrder.receiptId}\n` +
          `Total: ${currentViewOrder.totalAmount} SAR\n` +
          `Status: ${currentViewOrder.status || "New"}\n\n` +
          `Thank you for choosing our services!`;

        const phone = currentViewOrder.phoneNumber
          ? `966${currentViewOrder.phoneNumber}`
          : "966557485529";
        window.open(
          `https://wa.me/${phone}?text=${encodeURIComponent(message)}`,
          "_blank"
        );
      }

      // Close receipt modal
      function closeReceiptModal() {
        document.getElementById("receiptModal").classList.remove("show");
        currentViewOrder = null;
        // Restore original title
        document.title = originalTitle;
      }

      // Open status update modal
      function openStatusModal(receiptId, orderNumber, currentStatus) {
        currentUpdateOrder = { receiptId, orderNumber, currentStatus };
        document.getElementById("modalOrderNumber").textContent =
          orderNumber || "-";

        // Set current status
        const statusRadios = document.querySelectorAll(
          'input[name="statusUpdate"]'
        );
        statusRadios.forEach((radio) => {
          radio.checked = radio.value === currentStatus;
        });

        document.getElementById("statusUpdateModal").classList.add("show");
      }

      // Close status modal
      function closeStatusModal() {
        document.getElementById("statusUpdateModal").classList.remove("show");
        currentUpdateOrder = null;
      }

      // Update order status - renamed to avoid conflict
      async function performStatusUpdate() {
        if (!currentUpdateOrder) return;

        const selectedStatus = document.querySelector(
          'input[name="statusUpdate"]:checked'
        )?.value;
        if (!selectedStatus) {
          showNotification("Please select a status", "warning");
          return;
        }

        try {
          showNotification("Updating status...", "info");

          if (typeof updateOrderStatus !== "function") {
            console.error("updateOrderStatus function not found");
            showNotification(
              "System error. Please refresh and try again.",
              "error"
            );
            return;
          }

          // Update in DB
          await updateOrderStatus(currentUpdateOrder.receiptId, selectedStatus);

          // Update row before closing modal
          const row = document
            .querySelector(
              `button.action-btn-update[onclick*="${currentUpdateOrder.receiptId}"]`
            )
            ?.closest("tr");

          if (row) {
            const badge = row.querySelector(".order-status-badge");
            if (badge) {
              badge.textContent = selectedStatus;
              badge.className =
                "order-status-badge " + getStatusClass(selectedStatus);
            }
          }

          showNotification("Status updated successfully", "success");
          closeStatusModal();
        } catch (error) {
          console.error("Error updating status:", error);
          showNotification("Error updating status", "error");
        }
      }

      // Rest of your functions remain the same...
      // Use customer data for new order
      function useCustomerData() {
        if (currentCustomerData && customerOrders.length > 0) {
          const latestOrder = customerOrders[0];

          // Store customer data in localStorage
          localStorage.setItem(
            "prefillCustomer",
            JSON.stringify({
              name: currentCustomerData.name,
              phone: currentCustomerData.phone,
              measurements: {
                length: latestOrder.length,
                shoulder: latestOrder.shoulder,
                sleeveLength: latestOrder.sleeveLength,
                sleeveWidth: latestOrder.sleeveWidth,
                chestWidth: latestOrder.chestWidth,
                neck: latestOrder.neck,
                handWidth: latestOrder.handWidth,
                cuffLength: latestOrder.cuffLength,
              },
            })
          );
        }
      }

      // Print measurements
      // Updated printMeasurements function - Shows modal instead of printing directly
      function printMeasurements() {
        if (!currentCustomerData) {
          showNotification("No customer data to print", "warning");
          return;
        }

        // Get or create the print wrapper inside the modal
        let printWrapper = document.getElementById("measurementsPrintWrapper");

        // Get the latest measurements
        const latestOrder = customerOrders.length > 0 ? customerOrders[0] : {};

        // Generate print content
        printWrapper.innerHTML = `
    <div style="max-width: 800px; margin: 0 auto; font-family: 'Inter', sans-serif;">
      <!-- Header -->
      <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
        <h1 style="margin: 0; color: #2563eb;">SUHAIM TAILORING</h1>
        <p style="margin: 5px 0; color: #666;">Premium Men's Tailoring Services</p>
        <p style="margin: 5px 0; color: #666;">📞 +966 55 748 5529 | 📍 Riyadh, KSA</p>
      </div>

      <!-- Customer Info -->
      <div style="margin-bottom: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <h2 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">Customer Information</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          <div><strong>Name:</strong> ${currentCustomerData.name || "-"}</div>
          <div><strong>Phone:</strong> +966${
            currentCustomerData.phone || "-"
          }</div>
          <div><strong>Total Orders:</strong> ${customerOrders.length}</div>
          <div><strong>Member Since:</strong> ${formatDate(
            currentCustomerData.firstOrderDate
          )}</div>
        </div>
      </div>

      <!-- Measurements -->
      <div style="margin-bottom: 30px;">
        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">Latest Measurements</h2>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Length</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.length || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Shoulder</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.shoulder || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Sleeve Length</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.sleeveLength || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Sleeve Width</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.sleeveWidth || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Chest Width</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.chestWidth || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Neck</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.neck || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Hand Width</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.handWidth || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
          <div style="padding: 15px; background: #f9f9f9; border-left: 3px solid #2563eb; border-radius: 4px;">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Cuff Length</div>
            <div style="font-size: 20px; font-weight: bold; color: #333;">${
              latestOrder.cuffLength || "-"
            } <span style="font-size: 14px; color: #666;">cm</span></div>
          </div>
        </div>
      </div>

      <!-- Preferred Styles -->
      ${
        customerOrders.length > 0
          ? `
      <div style="margin-bottom: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <h2 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">Preferred Styles</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          ${
            latestOrder.garmentStyle
              ? `<div><strong>Garment Style:</strong> ${latestOrder.garmentStyle}</div>`
              : ""
          }
          ${
            latestOrder.jubjurType
              ? `<div><strong>Jubjur Type:</strong> ${latestOrder.jubjurType}</div>`
              : ""
          }
          ${
            latestOrder.pocketType
              ? `<div><strong>Pocket Type:</strong> ${latestOrder.pocketType}</div>`
              : ""
          }
          ${
            latestOrder.cuffType
              ? `<div><strong>Cuff Type:</strong> ${latestOrder.cuffType}</div>`
              : ""
          }
          ${
            latestOrder.collarType
              ? `<div><strong>Collar Type:</strong> ${latestOrder.collarType}</div>`
              : ""
          }
          ${
            latestOrder.fabricType
              ? `<div><strong>Fabric Type:</strong> ${latestOrder.fabricType}</div>`
              : ""
          }
        </div>
      </div>
      `
          : ""
      }

      <!-- Footer -->
      <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
        <p>Printed on: ${new Date().toLocaleDateString()} | Customer Profile Measurements</p>
        <p style="margin-top: 10px;">Thank you for choosing Suhaim Tailoring!</p>
      </div>
    </div>
  `;

        // Show the modal (NO PRINTING YET!)
        document.getElementById("measurementsModal").style.display = "flex";
        document.getElementById("measurementsModal").classList.add("show");
      }

      // New function to actually print when user clicks print button in modal
      function printMeasurementsNow() {
        // Add print class to body
        document.body.classList.add("printing-measurements");

        // Now trigger print
        setTimeout(() => {
          window.print();
          // Clean up after printing
          setTimeout(() => {
            document.body.classList.remove("printing-measurements");
          }, 100);
        }, 100);
      }

      // Function to close measurements modal
      function closeMeasurementsModal() {
        document.getElementById("measurementsModal").style.display = "none";
        document.getElementById("measurementsModal").classList.remove("show");
      }

      // Export customer data
      function exportCustomerData() {
        if (!currentCustomerData) return;

        const exportData = {
          customer: currentCustomerData,
          orders: customerOrders,
          exportDate: new Date().toISOString(),
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataUri =
          "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const exportFileDefaultName = `customer_${
          currentCustomerData.phone
        }_${Date.now()}.json`;

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportFileDefaultName);
        linkElement.click();
      }

      // Send measurements via WhatsApp
      function sendMeasurementsWhatsApp() {
        if (!currentCustomerData || customerOrders.length === 0) return;

        const latestOrder = customerOrders[0];
        let message = ` Hello, Customer: ${currentCustomerData.name}\n`;
        message += `Phone: +966${currentCustomerData.phone}\n\n`;
        message += `\n Your Order of \nOrder Id: ${latestOrder.orderNumber} \nReceipt Id: ${latestOrder.receiptId}. \nIs ready ready for delivery. \nPlease collect it at your earliest convenience. !!! Don't forget to bring your receipt with you. \nThank you for choosing our tailoring services!`;

        const phone = currentCustomerData.phone;
        window.open(
          `https://wa.me/${phone}?text=${encodeURIComponent(message)}`,
          "_blank"
        );
      }

      // Extract preferred designs from order history
      function extractPreferredDesigns(orders) {
        const designs = {};

        orders.forEach((order) => {
          if (order.garmentStyle)
            designs[order.garmentStyle] =
              (designs[order.garmentStyle] || 0) + 1;
          if (order.jubjurType)
            designs[order.jubjurType] = (designs[order.jubjurType] || 0) + 1;
          if (order.pocketType)
            designs[order.pocketType] = (designs[order.pocketType] || 0) + 1;
        });

        const preferredDesignsDiv = document.getElementById("preferredDesigns");
        preferredDesignsDiv.innerHTML = "";

        Object.entries(designs)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .forEach(([design, count]) => {
            const badge = document.createElement("span");
            badge.style.cssText =
              "padding: 0.5rem 1rem; background: var(--gray-100); border-radius: 9999px; font-size: 0.875rem;";
            badge.textContent = `${design} (${count})`;
            preferredDesignsDiv.appendChild(badge);
          });
      }

      // Load customer preferences
      function loadCustomerPreferences(phone) {
        const prefs = localStorage.getItem(`customerPrefs_${phone}`);
        if (prefs) {
          const parsed = JSON.parse(prefs);
          document.getElementById("prefSMS").checked = parsed.sms || false;
          document.getElementById("prefWhatsApp").checked =
            parsed.whatsapp !== false;
        }
      }

      // Save preferences
      function savePreferences() {
        if (!currentCustomerData) return;

        const prefs = {
          sms: document.getElementById("prefSMS").checked,
          whatsapp: document.getElementById("prefWhatsApp").checked,
        };

        localStorage.setItem(
          `customerPrefs_${currentCustomerData.phone}`,
          JSON.stringify(prefs)
        );
        showNotification("Preferences saved successfully", "success");
      }

      // Open WhatsApp
      function openWhatsApp() {
        const phone = "966557485529";
        const message = encodeURIComponent(
          "Hello, I would like to inquire about tailoring services."
        );
        window.open(`https://wa.me/${phone}?text=${message}`, "_blank");
      }

      // Format date
      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "-";

        const options = { year: "numeric", month: "short", day: "numeric" };

        if (currentLang === "ar") {
          return date.toLocaleDateString("ar-SA", options);
        } else if (currentLang === "bn") {
          return date.toLocaleDateString("bn-BD", options);
        } else {
          return date.toLocaleDateString("en-US", options);
        }
      }

      // Get currency
      function getCurrency() {
        return currentLang === "ar"
          ? "ريال"
          : currentLang === "bn"
          ? "রিয়াল"
          : "SAR";
      }

      // Show notification
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `alert alert-${type}`;
        notification.innerHTML = `
                <i class="fas fa-${
                  type === "success"
                    ? "check-circle"
                    : type === "error"
                    ? "exclamation-circle"
                    : type === "warning"
                    ? "exclamation-triangle"
                    : "info-circle"
                }"></i>
                <span>${message}</span>
            `;

        let container = document.getElementById("notificationContainer");
        if (!container) {
          container = document.createElement("div");
          container.id = "notificationContainer";
          container.style.cssText =
            "position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;";
          document.body.appendChild(container);
        }

        container.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideUp 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }
    </script>
  </body>
</html>
