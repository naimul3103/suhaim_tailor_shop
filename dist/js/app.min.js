let currentStep=1;const totalSteps=4;let formData={},currentLang="en";function initializeApp(){generateOrderNumber(),setDefaultDates(),checkPrefillData(),initializeFormListeners();const e=localStorage.getItem("preferredLanguage")||"en";changeLanguage(e),"undefined"!=typeof QRCode&&console.log("QR Code library loaded")}function generateOrderNumber(){let e=parseInt(sessionStorage.getItem("orderCounter")||"0");e++,e>9999&&(e=1),sessionStorage.setItem("orderCounter",e.toString());const t=`ORD-${String(e).padStart(4,"0")}`;return document.getElementById("orderNumber").textContent=t,t}function setDefaultDates(){const e=new Date,t=new Date;t.setDate(e.getDate()+7),document.querySelector('input[name="orderDate"]').valueAsDate=e,document.querySelector('input[name="deliveryDate"]').valueAsDate=t}function checkPrefillData(){const e=localStorage.getItem("prefillCustomer");if(e){const t=JSON.parse(e);t.name&&(document.querySelector('input[name="customerName"]').value=t.name),t.phone&&(document.querySelector('input[name="phoneNumber"]').value=t.phone),t.measurements&&Object.keys(t.measurements).forEach(e=>{const n=document.querySelector(`input[name="${e}"]`);n&&"-"!==t.measurements[e]&&(n.value=t.measurements[e])}),localStorage.removeItem("prefillCustomer"),showNotification("Customer data loaded successfully","success")}}function initializeFormListeners(){document.getElementById("totalAmount").addEventListener("input",calculateRemaining),document.getElementById("paidAmount").addEventListener("input",calculateRemaining),document.getElementById("tailorForm").addEventListener("submit",handleFormSubmit),document.querySelector('select[name="priority"]').addEventListener("change",function(){"express"===this.value&&showNotification("Express delivery will incur additional charges","info")})}function calculateRemaining(){const e=(parseFloat(document.getElementById("totalAmount").value)||0)-(parseFloat(document.getElementById("paidAmount").value)||0);document.getElementById("remainingAmount").value=e.toFixed(2);const t=document.getElementById("remainingAmount");t.style.color=e>0?"#ef4444":0===e?"#22c55e":"#f59e0b"}async function handleFormSubmit(e){e.preventDefault();const t=document.getElementById("submitBtn"),n=t.innerHTML;t.innerHTML='<span class="loading"></span> '+getTranslation("saving"),t.disabled=!0,formData=collectFormData();try{await saveToGoogleSheets(formData);generateReceipt(formData),document.getElementById("receiptModal").classList.add("show"),await sendNotifications(formData),showNotification(getTranslation("orderSaved"),"success")}catch(e){console.error("Error saving order:",e),showNotification(getTranslation("errorSaving"),"error")}finally{t.innerHTML=n,t.disabled=!1}}function collectFormData(){const e=document.getElementById("tailorForm");return{orderNumber:document.getElementById("orderNumber").textContent,receiptId:generateReceiptId(),timestamp:(new Date).toISOString(),language:currentLang,customerName:e.customerName.value,phoneNumber:e.phoneNumber.value,orderDate:e.orderDate.value,deliveryDate:e.deliveryDate.value,thobeCount:e.thobeCount.value,priority:e.priority.value,length:e.length.value||"-",shoulder:e.shoulder.value||"-",sleeveLength:e.sleeveLength.value||"-",sleeveWidth:e.sleeveWidth.value||"-",chestWidth:e.chestWidth.value||"-",neck:e.neck.value||"-",handWidth:e.handWidth.value||"-",cuffLength:e.cuffLength.value||"-",jubjurType:e.jubjurType.value||"-",pocketType:e.pocketType.value||"-",cuffType:e.cuffType.value||"-",collarType:e.collarType.value||"-",garmentStyle:e.garmentStyle.value||"-",stitchDouble:e.stitchDouble.checked?"Yes":"No",stitchHidden:e.stitchHidden.checked?"Yes":"No",tailorTail:e.tailorTail.checked?"Yes":"No",jacket:e.jacket.checked?"Yes":"No",embroidery:e.embroidery.checked?"Yes":"No",specialRequest:e.specialRequest.checked?"Yes":"No",fabricType:e.fabricType.value||"-",color:e.color.value||"-",plain:e.plain.value||"-",totalAmount:e.totalAmount.value||"0",paidAmount:e.paidAmount.value||"0",remainingAmount:e.remainingAmount.value||"0",paymentMethod:e.paymentMethod.value,notes:e.notes.value||""}}function generateReceiptId(){return"RCP"+Date.now().toString().slice(-8)}async function loadLastMeasurements(){const e=document.querySelector('input[name="phoneNumber"]').value;if(e)try{const t=await searchCustomer(e);if("success"===t.status&&t.orders.length>0){const e=t.orders[0];["customerName","length","shoulder","sleeveLength","sleeveWidth","chestWidth","neck","handWidth","cuffLength","jubjurType","pocketType","cuffType","collarType","garmentStyle"].forEach(t=>{const n=document.querySelector(`input[name="${t}"]`);n&&e[t]&&"-"!==e[t]&&(n.value=e[t])}),showNotification(getTranslation("measurementsLoaded"),"success")}else showNotification(getTranslation("noMeasurements"),"info")}catch(e){console.error("Error loading measurements:",e),showNotification(getTranslation("errorLoading"),"error")}else showNotification(getTranslation("enterPhone"),"warning")}function openWhatsApp(){const e=encodeURIComponent("Hello, I would like to inquire about tailoring services.");window.open(`https://wa.me/966557485529?text=${e}`,"_blank")}function sendWhatsApp(){const e=formData.phoneNumber.replace(/\D/g,""),t=generateWhatsAppMessage(formData);window.open(`https://wa.me/966${e}?text=${encodeURIComponent(t)}`,"_blank")}function generateWhatsAppMessage(e){let t="";return"ar"===currentLang?(t=`مرحباً ${e.customerName},\n\n`,t+="شكراً لطلبك من مؤسسة سجيم إبراهيم محمد الفضلي للخياطة.\n\n",t+="📋 تفاصيل الطلب:\n",t+=`رقم الطلب: ${e.orderNumber}\n`,t+=`رقم الإيصال: ${e.receiptId}\n`,t+=`تاريخ التسليم: ${formatDate(e.deliveryDate)}\n`,t+=`عدد الثياب: ${e.thobeCount}\n\n`,t+="💰 الدفع:\n",t+=`الإجمالي: ${e.totalAmount} ريال\n`,t+=`المدفوع: ${e.paidAmount} ريال\n`,t+=`المتبقي: ${e.remainingAmount} ريال\n\n`,t+="📍 العنوان: الرياض - حي الحمراء - شارع المصانع\n",t+="📞 للاستفسار: 0557450529\n\n",t+="يمكنك تتبع طلبك من خلال الرابط:\n",t+=`${window.location.origin}/order-status.html?id=${e.receiptId}`):"bn"===currentLang?(t=`হ্যালো ${e.customerName},\n\n`,t+="সামি ইব্রাহিম মুহাম্মদ আলফাদলি টেইলারিং থেকে আপনার অর্ডারের জন্য ধন্যবাদ।\n\n",t+="📋 অর্ডার বিবরণ:\n",t+=`অর্ডার নম্বর: ${e.orderNumber}\n`,t+=`রসিদ নম্বর: ${e.receiptId}\n`,t+=`ডেলিভারি তারিখ: ${formatDate(e.deliveryDate)}\n`,t+=`পোশাক সংখ্যা: ${e.thobeCount}\n\n`,t+="💰 পেমেন্ট:\n",t+=`মোট: ${e.totalAmount} রিয়াল\n`,t+=`পরিশোধিত: ${e.paidAmount} রিয়াল\n`,t+=`বাকি: ${e.remainingAmount} রিয়াল\n\n`,t+="📍 ঠিকানা: রিয়াদ - আল হামরা জেলা - আল মাসানে রাস্তা\n",t+="📞 যোগাযোগ: 0557450529\n\n",t+="আপনার অর্ডার ট্র্যাক করুন:\n",t+=`${window.location.origin}/order-status.html?id=${e.receiptId}`):(t=`Hello ${e.customerName},\n\n`,t+="Thank you for your order at Samee Ibrahim Muhammad Alfadhli Tailoring.\n\n",t+="📋 Order Details:\n",t+=`Order Number: ${e.orderNumber}\n`,t+=`Receipt ID: ${e.receiptId}\n`,t+=`Delivery Date: ${formatDate(e.deliveryDate)}\n`,t+=`Number of Thobes: ${e.thobeCount}\n\n`,t+="💰 Payment:\n",t+=`Total: ${e.totalAmount} SAR\n`,t+=`Paid: ${e.paidAmount} SAR\n`,t+=`Remaining: ${e.remainingAmount} SAR\n\n`,t+="📍 Address: Riyadh - Al Hamra District - Al Masane Street\n",t+="📞 Contact: 0557450529\n\n",t+="Track your order:\n",t+=`${window.location.origin}/order-status.html?id=${e.receiptId}`),t}async function sendNotifications(e){console.log("Sending notifications for order:",e.orderNumber);localStorage.setItem(`notifications_${e.receiptId}`,JSON.stringify({orderConfirmation:!0,readyForPickup:!1,delivered:!1}))}function newOrder(){document.getElementById("tailorForm").reset(),generateOrderNumber(),setDefaultDates(),document.getElementById("receiptModal").classList.remove("show"),scrollToTop()}function printReceipt(){const e=document.getElementById("receipt");if(!e)return void console.error("Element with ID 'receipt' not found.");const t=e.querySelector(".badge-number"),n=t?t.textContent.trim():"Receipt",o=document.createElement("iframe");o.style.position="absolute",o.style.width="0",o.style.height="0",o.style.border="0",o.style.left="-9999px",document.body.appendChild(o);const r=o.contentWindow,a=r.document,i=document.querySelector('link[href*="receipt.css"]'),c=i?i.href:`${window.location.origin}/css/receipt.css`,s=document.querySelector('link[href*="fontawesome"], link[href*="font-awesome"], link[href*="fa"]'),l=s?s.href:"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css";function u(){setTimeout(()=>{o&&o.parentNode&&document.body.removeChild(o)},100)}function d(){try{if(r.focus(),r.matchMedia){r.matchMedia("print").addListener(function(e){e.matches||u()})}r.onafterprint=u,r.print()}catch(e){console.error("Print error:",e),u()}}a.open(),a.write(`<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Order-${n}</title>\n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">\n    <link rel="stylesheet" href="${l}">\n    <link rel="stylesheet" href="${c}">\n</head>\n<body>\n    ${e.outerHTML}\n</body>\n</html>`),a.close();let m=0;function p(){m++,m>=3&&setTimeout(d,300)}const h=setInterval(()=>{try{const e=a.body.querySelector(".modern-receipt-container");if(e){r.getComputedStyle(e).fontFamily.includes("Inter")&&(clearInterval(h),p())}}catch(e){}},50);setTimeout(()=>{clearInterval(h),o.parentNode&&d()},3e3),o.onload=p,r.addEventListener("load",p)}async function loadLastMeasurements(){const e=document.querySelector('input[name="phoneNumber"]').value;if(e)try{const t=await searchCustomer(e);if("success"===t.status&&t.orders.length>0){const e=t.orders[0];["customerName","length","shoulder","sleeveLength","sleeveWidth","chestWidth","neck","handWidth","cuffLength"].forEach(t=>{const n=document.querySelector(`input[name="${t}"]`);n&&e[t]&&"-"!==e[t]&&(n.value=e[t])});["jubjurType","pocketType","cuffType","collarType"].forEach(t=>{if(e[t]&&"-"!==e[t]){const n=document.querySelector(`input[name="${t}"][value="${e[t]}"]`);n&&(n.checked=!0)}});["garmentStyle","priority"].forEach(t=>{if(e[t]&&"-"!==e[t]){const n=document.querySelector(`select[name="${t}"]`);n&&(n.value=e[t])}});if(["stitchDouble","stitchHidden","tailorTail","jacket","embroidery","specialRequest"].forEach(t=>{const n=document.querySelector(`input[name="${t}"]`);n&&(n.checked="Yes"===e[t]||!0===e[t]||1===e[t]||"1"===e[t])}),e.thobeCount){const t=document.querySelector('input[name="thobeCount"]');t&&(t.value=e.thobeCount)}if(e.notes){const t=document.querySelector('textarea[name="notes"]');t&&(t.value=e.notes)}showNotification(getTranslation("measurementsLoaded"),"success")}else showNotification(getTranslation("noMeasurements"),"info")}catch(e){console.error("Error loading measurements:",e),showNotification(getTranslation("errorLoading"),"error")}else showNotification(getTranslation("enterPhone"),"warning")}function showNotification(e,t="info"){const n=document.createElement("div");n.className=`alert alert-${t}`,n.innerHTML=`\n        <i class="fas fa-${"success"===t?"check-circle":"error"===t?"exclamation-circle":"info-circle"}"></i>\n        <span>${e}</span>\n    `;let o=document.getElementById("notificationContainer");o||(o=document.createElement("div"),o.id="notificationContainer",o.style.cssText="position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;",document.body.appendChild(o)),o.appendChild(n),setTimeout(()=>{n.style.animation="slideUp 0.3s ease",setTimeout(()=>n.remove(),300)},5e3)}function formatDate(e){const t=new Date(e),n={year:"numeric",month:"long",day:"numeric"};return"ar"===currentLang?t.toLocaleDateString("ar-SA",n):"bn"===currentLang?t.toLocaleDateString("bn-BD",n):t.toLocaleDateString("en-US",n)}function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}document.addEventListener("DOMContentLoaded",function(){initializeApp()}),window.loadLastMeasurements=loadLastMeasurements,window.openWhatsApp=openWhatsApp,window.sendWhatsApp=sendWhatsApp,window.printReceipt=printReceipt,window.newOrder=newOrder;