<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Profile - Suhaim Tailoring</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/form.css" />
    <link rel="stylesheet" href="css/receipt.css" />
    <link rel="stylesheet" href="css/responsive.css" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@400;600;700&family=Noto+Sans+Bengali:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      /* Customer Profile Specific Styles */
      .profile-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .search-header {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
        text-align: center;
      }

      .search-box-container {
        max-width: 600px;
        margin: 2rem auto;
      }

      .search-input-group {
        display: flex;
        gap: 1rem;
      }

      .search-input-group input {
        flex: 1;
      }

      .customer-profile-card {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .customer-profile-card.show {
        display: block;
      }

      .profile-overview {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
      }

      .profile-header-info {
        display: flex;
        /* 
        justify-content: space-between;
        align-items: center; 
        gap: 2rem; 
        */
        flex-wrap: wrap;
        flex-direction: column;
      }

      .customer-details {
        flex: 1;
        padding-bottom: 25px;
        align-items: center;
        justify-items: center;
      }

      .customer-avatar {
        width: 80px;
        height: 80px;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }

      .customer-name {
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
      }

      .customer-info-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray-600);
        margin-bottom: 0.5rem;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(30px, 1fr));
        gap: 1rem;
      }

      .stat-card {
        background: var(--gray-50);
        padding: 1.5rem;
        border-radius: 0.75rem;
        text-align: center;
        border: 2px solid transparent;
        transition: all var(--transition-base);
      }

      .stat-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .profile-tabs {
        background: white;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
      }

      .tab-button {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        color: var(--gray-600);
        cursor: pointer;
        transition: all var(--transition-base);
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .tab-button.active {
        background: var(--primary-color);
        color: white;
      }

      .tab-button:hover:not(.active) {
        background: var(--gray-100);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      .measurements-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
      }

      .measurements-display-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .measurement-card {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: 0.75rem;
        border-left: 4px solid var(--primary-color);
        transition: all var(--transition-base);
        /* justify-items: center; */
      }

      .measurement-card:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-md);
      }

      .measurement-label {
        font-size: 0.75rem;
        color: var(--primary-color);
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-bottom: 0.5rem;
        width: 500px;
        font-weight: bolder;
      }

      .measurement-value {
        display: flex;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--gray-900);
        align-items: center;
      }

      .measurement-unit {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-left: 0.25rem;
      }

      .orders-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
      }

      .orders-table {
        width: 100%;
        margin-top: 1.5rem;
      }

      .orders-table thead {
        background: var(--gray-50);
      }

      .orders-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .orders-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .orders-table tbody tr:hover {
        background: var(--gray-50);
      }

      .order-status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-new {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
      }

      .status-progress {
        background: rgba(251, 146, 60, 0.1);
        color: #fb923c;
      }

      .status-ready {
        background: rgba(250, 204, 21, 0.1);
        color: #facc15;
      }

      .status-delivered {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
      }

      .status-cancelled {
        background: rgba(107, 114, 128, 0.1);
        color: #6b7280;
      }

      .action-buttons-group {
        display: flex;
        gap: 0.5rem;
      }

      .action-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-base);
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .action-btn-view {
        background: var(--primary-color);
        color: white;
      }

      .action-btn-view:hover {
        background: var(--primary-dark);
      }

      .action-btn-print {
        background: var(--gray-200);
        color: var(--gray-700);
      }

      .action-btn-print:hover {
        background: var(--gray-300);
      }

      .action-btn-update {
        background: var(--success-color);
        color: white;
      }

      .action-btn-update:hover {
        background: var(--secondary-dark);
      }

      .quick-actions-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .quick-action-card {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-base);
        text-decoration: none;
        color: var(--gray-900);
      }

      .quick-action-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .quick-action-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(
          135deg,
          var(--primary-light),
          var(--primary-color)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 1.5rem;
      }

      .quick-action-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .quick-action-desc {
        font-size: 0.875rem;
        color: var(--gray-600);
      }

      .no-data-message {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-500);
      }

      .no-data-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .status-update-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      .status-update-modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray-500);
      }

      .status-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 1.5rem 0;
      }

      .status-option {
        padding: 1rem;
        border: 2px solid var(--gray-200);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .status-option:hover {
        border-color: var(--primary-color);
        background: var(--gray-50);
      }

      .status-option.selected {
        border-color: var(--primary-color);
        background: rgba(37, 99, 235, 0.05);
      }

      @media (max-width: 768px) {
        .profile-header-info {
          flex-direction: column;
          text-align: center;
        }

        .customer-avatar {
          margin: 0 auto 1rem;
        }

        .stats-container {
          grid-template-columns: repeat(2, 1fr);
        }

        .orders-table {
          font-size: 0.875rem;
        }

        .action-buttons-group {
          flex-direction: column;
        }

        .quick-actions-section {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Language Selector -->
    <div class="language-selector">
      <select id="languageSelect" onchange="changeLanguage(this.value)">
        <option value="en">🇬🇧 English</option>
        <option value="ar">🇸🇦 العربية</option>
        <option value="bn">🇧🇩 বাংলা</option>
      </select>
    </div>

    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">
      <a href="index.html" class="action-link">
        <i class="fas fa-home"></i>
        <span data-lang="home">Home</span>
      </a>
      <a href="order-status.html" class="action-link">
        <i class="fas fa-truck"></i>
        <span data-lang="trackOrder">Track Order</span>
      </a>
      <a href="#" class="action-link" onclick="openWhatsApp()">
        <i class="fab fa-whatsapp"></i>
        <span data-lang="whatsappSupport">WhatsApp</span>
      </a>
    </div>

    <div class="container profile-container">
      <!-- Search Header -->
      <div class="search-header">
        <h1>
          <i class="fas fa-users"></i>
          <span data-lang="customerProfile">Customer Profile</span>
        </h1>
        <p data-lang="searchDescription"
          >Search customers by phone number to view their profile and order
          history</p
        >

        <div class="search-box-container">
          <div class="search-input-group">
            <input
              type="tel"
              id="searchPhone"
              class="form-control"
              placeholder="Enter phone number (e.g., 0501234567)"
              data-placeholder-key="enterPhoneNumber"
            />
            <button class="btn-primary" onclick="performCustomerSearch()">
              <i class="fas fa-search"></i>
              <span data-lang="search">Search</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Customer Profile Card -->
      <div class="customer-profile-card" id="customerProfileCard">
        <!-- Profile Overview -->
        <div class="profile-overview">
          <div class="profile-header-info">
            <div class="customer-details">
              <div class="customer-avatar" id="customerAvatar">
                <i class="fas fa-user"></i>
              </div>
              <h2 class="customer-name" id="customerName">-</h2>
              <div class="customer-info-row">
                <i class="fas fa-phone"></i>
                <span id="customerPhone">-</span>
              </div>
              <div class="customer-info-row">
                <i class="fas fa-calendar"></i>
                <span data-lang="memberSince">Member since</span>
                <span id="memberSince">-</span>
              </div>
            </div>

            <div class="stats-container">
              <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label" data-lang="totalOrders"
                  >Total Orders</div
                >
              </div>
              <div class="stat-card">
                <div class="stat-value" id="totalSpent">0</div>
                <div class="stat-label" data-lang="totalSpent">Total (SAR)</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="pendingAmount">0</div>
                <div class="stat-label" data-lang="pendingAmount">Pending</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="completedOrders">0</div>
                <div class="stat-label" data-lang="completed">Completed</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Tabs -->
        <div class="profile-tabs">
          <button class="tab-button active" onclick="switchTab('measurements')">
            <i class="fas fa-ruler"></i>
            <span data-lang="measurements">Measurements</span>
          </button>
          <button class="tab-button" onclick="switchTab('orders')">
            <i class="fas fa-history"></i>
            <span data-lang="orderHistory">Order History</span>
          </button>
          <button class="tab-button" onclick="switchTab('preferences')">
            <i class="fas fa-cog"></i>
            <span data-lang="preferences">Preferences</span>
          </button>
        </div>

        <!-- Measurements Tab -->
        <div class="tab-content active" id="measurementsTab">
          <div class="measurements-section">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
              "
            >
              <h3>
                <i class="fas fa-ruler-combined"></i>
                <span data-lang="latestMeasurements">Latest Measurements</span>
              </h3>
              <button class="btn-secondary" onclick="printMeasurements()">
                <i class="fas fa-print"></i>
                <span data-lang="print">Print</span>
              </button>
            </div>

            <div class="measurements-display-grid">
              <div class="measurement-card">
                <div class="measurement-label" data-lang="length">Length</div>
                <div class="measurement-value">
                  <span id="m-length">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="shoulder"
                  >Shoulder</div
                >f
                <div class="measurement-value">
                  <span id="m-shoulder">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="sleeveLength"
                  >Sleeve Length</div
                >
                <div class="measurement-value">
                  <span id="m-sleeveLength">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="sleeveWidth"
                  >Sleeve Width</div
                >
                <div class="measurement-value">
                  <span id="m-sleeveWidth">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="chestWidth"
                  >Chest Width</div
                >
                <div class="measurement-value">
                  <span id="m-chestWidth">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="neck">Neck</div>
                <div class="measurement-value">
                  <span id="m-neck">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="handWidth"
                  >Hand Width</div
                >
                <div class="measurement-value">
                  <span id="m-handWidth">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
              <div class="measurement-card">
                <div class="measurement-label" data-lang="cuffLength"
                  >Cuff Length</div
                >
                <div class="measurement-value">
                  <span id="m-cuffLength">-</span>
                  <span class="measurement-unit">cm</span>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions-section">
              <a
                href="index.html"
                class="quick-action-card"
                onclick="useCustomerData()"
              >
                <div class="quick-action-icon">
                  <i class="fas fa-plus"></i>
                </div>
                <div class="quick-action-title" data-lang="newOrder"
                  >New Order</div
                >
                <div class="quick-action-desc" data-lang="useSavedMeasurements"
                  >Use saved measurements</div
                >
              </a>

              <div class="quick-action-card" onclick="exportCustomerData()">
                <div class="quick-action-icon">
                  <i class="fas fa-download"></i>
                </div>
                <div class="quick-action-title" data-lang="exportData"
                  >Export Data</div
                >
                <div class="quick-action-desc" data-lang="downloadCustomerInfo"
                  >Download customer information</div
                >
              </div>

              <div
                class="quick-action-card"
                onclick="sendMeasurementsWhatsApp()"
              >
                <div class="quick-action-icon">
                  <i class="fab fa-whatsapp"></i>
                </div>
                <div class="quick-action-title" data-lang="sendWhatsApp"
                  >Send WhatsApp</div
                >
                <div class="quick-action-desc" data-lang="shareMeasurements"
                  >Share measurements via WhatsApp</div
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content" id="ordersTab">
          <div class="orders-section">
            <h3>
              <i class="fas fa-shopping-bag"></i>
              <span data-lang="orderHistory">Order History</span>
            </h3>

            <table class="orders-table">
              <thead>
                <tr>
                  <th data-lang="orderNumber">Order #</th>
                  <th data-lang="date">Date</th>
                  <th data-lang="items">Items</th>
                  <th data-lang="total">Total</th>
                  <th data-lang="status">Status</th>
                  <th data-lang="actions">Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <!-- Orders will be populated here -->
              </tbody>
            </table>

            <div
              class="no-data-message"
              id="noOrdersMessage"
              style="display: none"
            >
              <div class="no-data-icon">
                <i class="fas fa-inbox"></i>
              </div>
              <h3 data-lang="noOrders">No Orders Found</h3>
              <p data-lang="noOrdersDesc">This customer has no order history</p>
            </div>
          </div>
        </div>

        <!-- Preferences Tab -->
        <div class="tab-content" id="preferencesTab">
          <div class="measurements-section">
            <h3>
              <i class="fas fa-user-cog"></i>
              <span data-lang="customerPreferences">Customer Preferences</span>
            </h3>

            <div style="margin-top: 1.5rem">
              <h4
                style="margin-bottom: 1rem"
                data-lang="notificationPreferences"
                >Notification Preferences</h4
              >

              <div style="display: flex; flex-direction: column; gap: 1rem">
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 1rem;
                    background: var(--gray-50);
                    border-radius: 0.5rem;
                  "
                >
                  <input
                    type="checkbox"
                    id="prefSMS"
                    style="width: 20px; height: 20px"
                  />
                  <div>
                    <strong data-lang="smsNotifications"
                      >SMS Notifications</strong
                    >
                    <p
                      style="color: var(--gray-600); font-size: 0.875rem"
                      data-lang="smsDesc"
                      >Receive order updates via SMS</p
                    >
                  </div>
                </label>

                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 1rem;
                    background: var(--gray-50);
                    border-radius: 0.5rem;
                  "
                >
                  <input
                    type="checkbox"
                    id="prefWhatsApp"
                    checked
                    style="width: 20px; height: 20px"
                  />
                  <div>
                    <strong data-lang="whatsappNotifications"
                      >WhatsApp Notifications</strong
                    >
                    <p
                      style="color: var(--gray-600); font-size: 0.875rem"
                      data-lang="whatsappDesc"
                      >Receive order updates via WhatsApp</p
                    >
                  </div>
                </label>
              </div>

              <h4 style="margin: 2rem 0 1rem" data-lang="preferredDesigns"
                >Preferred Designs</h4
              >
              <div
                id="preferredDesigns"
                style="display: flex; flex-wrap: wrap; gap: 0.5rem"
              >
                <!-- Will be populated based on order history -->
              </div>

              <button
                class="btn-primary"
                style="margin-top: 2rem"
                onclick="savePreferences()"
              >
                <i class="fas fa-save"></i>
                <span data-lang="savePreferences">Save Preferences</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Update Modal -->
    <div class="status-update-modal" id="statusUpdateModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" data-lang="updateOrderStatus"
            >Update Order Status</h2
          >
          <button class="modal-close" onclick="closeStatusModal()">×</button>
        </div>

        <div style="margin-bottom: 1rem">
          <strong data-lang="orderNumber">Order Number</strong>:
          <span id="modalOrderNumber">-</span>
        </div>

        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="New" />
            <span data-lang="statusNew">New</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="In Progress" />
            <span data-lang="statusProgress">In Progress</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="Ready" />
            <span data-lang="statusReady">Ready</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="Delivered" />
            <span data-lang="statusDelivered">Delivered</span>
          </label>
          <label class="status-option">
            <input type="radio" name="statusUpdate" value="Cancelled" />
            <span data-lang="statusCancelled">Cancelled</span>
          </label>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end">
          <button class="btn-secondary" onclick="closeStatusModal()">
            <span data-lang="cancel">Cancel</span>
          </button>
          <button class="btn-primary" onclick="performStatusUpdate()">
            <i class="fas fa-check"></i>
            <span data-lang="update">Update</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="js/language.js"></script>
    <script src="js/api.js"></script>

    <script>
      let currentLang = "en";
      let currentCustomerData = null;
      let customerOrders = [];
      let currentUpdateOrder = null;

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        // Set language
        const savedLang = localStorage.getItem("preferredLanguage") || "en";
        changeLanguage(savedLang);

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const phone = urlParams.get("phone");
        if (phone) {
          document.getElementById("searchPhone").value = phone;
          performCustomerSearch();
        }

        // Handle Enter key in search
        document
          .getElementById("searchPhone")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              performCustomerSearch();
            }
          });
      });

      // Search customer - renamed to avoid conflict
      async function performCustomerSearch() {
        const phoneNumber = document.getElementById("searchPhone").value.trim();

        if (!phoneNumber) {
          showNotification("Please enter a phone number", "warning");
          return;
        }

        showNotification("Searching...", "info");

        try {
          // Check if the searchCustomer function exists
          if (typeof searchCustomer !== "function") {
            console.error(
              "searchCustomer function not found. Make sure api.js is loaded properly."
            );
            showNotification(
              "System error. Please refresh and try again.",
              "error"
            );
            return;
          }

          // Call the API searchCustomer function
          const response = await searchCustomer(phoneNumber);

          if (response && response.status === "success" && response.customer) {
            displayCustomerProfile(response.customer, response.orders || []);
            document
              .getElementById("customerProfileCard")
              .classList.add("show");
            showNotification("Customer found!", "success");
          } else {
            showNotification(
              "No customer found with this phone number",
              "error"
            );
            document
              .getElementById("customerProfileCard")
              .classList.remove("show");
          }
        } catch (error) {
          console.error("Error searching customer:", error);
          showNotification(
            "Error searching customer. Please try again.",
            "error"
          );
        }
      }

      // Display customer profile
      function displayCustomerProfile(customer, orders) {
        currentCustomerData = customer;
        customerOrders = orders;

        // Update avatar with initials
        const initials = customer.name
          ? customer.name
              .split(" ")
              .map((n) => n[0])
              .join("")
              .toUpperCase()
          : "?";
        document.getElementById("customerAvatar").textContent = initials;

        // Update customer details
        document.getElementById("customerName").textContent =
          customer.name || "Unknown";
        document.getElementById("customerPhone").textContent =
          "+966" + (customer.phone || "");
        document.getElementById("memberSince").textContent = formatDate(
          customer.firstOrderDate
        );

        // Calculate statistics
        let totalAmount = 0;
        let pendingAmount = 0;
        let completedOrders = 0;

        orders.forEach((order) => {
          totalAmount += parseFloat(order.totalAmount) || 0;
          pendingAmount += parseFloat(order.remainingAmount) || 0;

          const status = order.status?.toLowerCase() || "";
          if (status.includes("delivered") || status.includes("تسليم")) {
            completedOrders++;
          }
        });

        // Update statistics
        document.getElementById("totalOrders").textContent = orders.length;
        document.getElementById("totalSpent").textContent =
          totalAmount.toFixed(0);
        document.getElementById("pendingAmount").textContent =
          pendingAmount.toFixed(0);
        document.getElementById("completedOrders").textContent =
          completedOrders;

        // Update measurements (from latest order)
        if (orders.length > 0) {
          const latestOrder = orders[0];
          updateMeasurements(latestOrder);

          // Extract preferred designs
          extractPreferredDesigns(orders);
        } else {
          // Clear measurements if no orders
          updateMeasurements({});
        }

        // Populate orders table
        populateOrdersTable(orders);

        // Load preferences
        loadCustomerPreferences(customer.phone);
      }

      // Update measurements display
      function updateMeasurements(order) {
        const measurements = [
          "length",
          "shoulder",
          "sleeveLength",
          "sleeveWidth",
          "chestWidth",
          "neck",
          "handWidth",
          "cuffLength",
        ];

        measurements.forEach((measurement) => {
          const value = order[measurement];
          const element = document.getElementById(`m-${measurement}`);
          if (element) {
            element.textContent = value && value !== "-" ? value : "-";
          }
        });
      }

      // Populate orders table
      function populateOrdersTable(orders) {
        const tbody = document.getElementById("ordersTableBody");
        tbody.innerHTML = "";

        if (orders.length === 0) {
          document.getElementById("noOrdersMessage").style.display = "block";
          document.querySelector(".orders-table").style.display = "none";
          return;
        }

        document.getElementById("noOrdersMessage").style.display = "none";
        document.querySelector(".orders-table").style.display = "table";

        orders.forEach((order) => {
          const row = document.createElement("tr");

          const statusClass = getStatusClass(order.status);

          row.innerHTML = `
                    <td>${order.orderNumber || "-"}</td>
                    <td>${formatDate(order.orderDate)}</td>
                    <td>${order.thobeCount || 1}</td>
                    <td>${order.totalAmount || "0"} ${getCurrency()}</td>
                    <td><span class="order-status-badge ${statusClass}">${
            order.status || "New"
          }</span></td>
                    <td>
                        <div class="action-buttons-group">
                            <button class="action-btn action-btn-view" onclick="viewOrder('${
                              order.receiptId
                            }')">
                                <i class="fas fa-eye"></i>
                                <span>View</span>
                            </button>
                            <button class="action-btn action-btn-print" onclick="printOrder('${
                              order.receiptId
                            }')">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="action-btn action-btn-update" onclick="openStatusModal('${
                              order.receiptId
                            }', '${order.orderNumber}', '${
            order.status || "New"
          }')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;

          tbody.appendChild(row);
        });
      }

      // Get status class
      function getStatusClass(status) {
        if (!status) return "status-new";
        const statusLower = status.toLowerCase();

        if (statusLower.includes("progress") || statusLower.includes("قيد"))
          return "status-progress";
        if (statusLower.includes("ready") || statusLower.includes("جاهز"))
          return "status-ready";
        if (statusLower.includes("delivered") || statusLower.includes("تسليم"))
          return "status-delivered";
        if (statusLower.includes("cancelled") || statusLower.includes("ملغى"))
          return "status-cancelled";
        return "status-new";
      }

      // Switch tabs
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.closest(".tab-button").classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`${tabName}Tab`).classList.add("active");
      }

      // View order
      function viewOrder(receiptId) {
        localStorage.setItem("viewReceiptId", receiptId);
        window.location.href = "index.html#receipt";
      }

      // Print order
      function printOrder(receiptId) {
        localStorage.setItem("viewReceiptId", receiptId);
        localStorage.setItem("autoPrint", "true");
        window.location.href = "index.html#receipt";
      }

      // Open status update modal
      function openStatusModal(receiptId, orderNumber, currentStatus) {
        currentUpdateOrder = { receiptId, orderNumber, currentStatus };
        document.getElementById("modalOrderNumber").textContent =
          orderNumber || "-";

        // Set current status
        const statusRadios = document.querySelectorAll(
          'input[name="statusUpdate"]'
        );
        statusRadios.forEach((radio) => {
          radio.checked = radio.value === currentStatus;
        });

        document.getElementById("statusUpdateModal").classList.add("show");
      }

      // Close status modal
      function closeStatusModal() {
        document.getElementById("statusUpdateModal").classList.remove("show");
        currentUpdateOrder = null;
      }

      // Update order status - renamed to avoid conflict
      async function performStatusUpdate() {
        if (!currentUpdateOrder) return;

        const selectedStatus = document.querySelector(
          'input[name="statusUpdate"]:checked'
        )?.value;
        if (!selectedStatus) {
          showNotification("Please select a status", "warning");
          return;
        }

        try {
          showNotification("Updating status...", "info");

          if (typeof updateOrderStatus !== "function") {
            console.error("updateOrderStatus function not found");
            showNotification(
              "System error. Please refresh and try again.",
              "error"
            );
            return;
          }

          // Update in DB
          await updateOrderStatus(currentUpdateOrder.receiptId, selectedStatus);

          // ✅ Update row before closing modal
          const row = document
            .querySelector(
              `button.action-btn-update[onclick*="${currentUpdateOrder.receiptId}"]`
            )
            ?.closest("tr");

          if (row) {
            const badge = row.querySelector(".order-status-badge");
            if (badge) {
              badge.textContent = selectedStatus;
              badge.className =
                "order-status-badge " + getStatusClass(selectedStatus);
            }
          }

          showNotification("Status updated successfully", "success");
          closeStatusModal();
        } catch (error) {
          console.error("Error updating status:", error);
          showNotification("Error updating status", "error");
        }
      }
      // Use customer data for new order
      function useCustomerData() {
        if (currentCustomerData && customerOrders.length > 0) {
          const latestOrder = customerOrders[0];

          // Store customer data in localStorage
          localStorage.setItem(
            "prefillCustomer",
            JSON.stringify({
              name: currentCustomerData.name,
              phone: currentCustomerData.phone,
              measurements: {
                length: latestOrder.length,
                shoulder: latestOrder.shoulder,
                sleeveLength: latestOrder.sleeveLength,
                sleeveWidth: latestOrder.sleeveWidth,
                chestWidth: latestOrder.chestWidth,
                neck: latestOrder.neck,
                handWidth: latestOrder.handWidth,
                cuffLength: latestOrder.cuffLength,
              },
            })
          );
        }
      }

      // Print measurements
      function printMeasurements() {
        window.print();
      }

      // Export customer data
      function exportCustomerData() {
        if (!currentCustomerData) return;

        const exportData = {
          customer: currentCustomerData,
          orders: customerOrders,
          exportDate: new Date().toISOString(),
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataUri =
          "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const exportFileDefaultName = `customer_${
          currentCustomerData.phone
        }_${Date.now()}.json`;

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportFileDefaultName);
        linkElement.click();
      }

      // Send measurements via WhatsApp
      function sendMeasurementsWhatsApp() {
        if (!currentCustomerData || customerOrders.length === 0) return;

        const latestOrder = customerOrders[0];
        let message = ` Hello, Customer: ${currentCustomerData.name}\n`;
        message += `Phone: +880${currentCustomerData.phone}\n\n`;
        /*message += `Latest Measurements:\n`;
        message += `Length: ${latestOrder.length} cm\n`;
        message += `Shoulder: ${latestOrder.shoulder} cm\n`;
        message += `Sleeve Length: ${latestOrder.sleeveLength} cm\n`;
        message += `Sleeve Width: ${latestOrder.sleeveWidth} cm\n`;
        message += `Chest Width: ${latestOrder.chestWidth} cm\n`;
        message += `Neck: ${latestOrder.neck} cm\n`;
        message += `Hand Width: ${latestOrder.handWidth} cm\n`;
        message += `Cuff Length: ${latestOrder.cuffLength} cm`;*/
        message += `\n Your Order of \nOrder Id: ${latestOrder.orderNumber} \nReceipt Id: ${latestOrder.receiptId}. \nIs ready ready for delivery. \nPlease collect it at your earliest convenience. !!! Don't forget to bring your receipt with you. \nThank you for choosing our tailoring services!`;

        const phone = currentCustomerData.phone;
        window.open(
          `https://wa.me/${phone}?text=${encodeURIComponent(message)}`,
          "_blank"
        );
      }

      // Extract preferred designs from order history
      function extractPreferredDesigns(orders) {
        const designs = {};

        orders.forEach((order) => {
          if (order.garmentStyle)
            designs[order.garmentStyle] =
              (designs[order.garmentStyle] || 0) + 1;
          if (order.jubjurType)
            designs[order.jubjurType] = (designs[order.jubjurType] || 0) + 1;
          if (order.pocketType)
            designs[order.pocketType] = (designs[order.pocketType] || 0) + 1;
        });

        const preferredDesignsDiv = document.getElementById("preferredDesigns");
        preferredDesignsDiv.innerHTML = "";

        Object.entries(designs)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .forEach(([design, count]) => {
            const badge = document.createElement("span");
            badge.style.cssText =
              "padding: 0.5rem 1rem; background: var(--gray-100); border-radius: 9999px; font-size: 0.875rem;";
            badge.textContent = `${design} (${count})`;
            preferredDesignsDiv.appendChild(badge);
          });
      }

      // Load customer preferences
      function loadCustomerPreferences(phone) {
        const prefs = localStorage.getItem(`customerPrefs_${phone}`);
        if (prefs) {
          const parsed = JSON.parse(prefs);
          document.getElementById("prefSMS").checked = parsed.sms || false;
          document.getElementById("prefWhatsApp").checked =
            parsed.whatsapp !== false;
        }
      }

      // Save preferences
      function savePreferences() {
        if (!currentCustomerData) return;

        const prefs = {
          sms: document.getElementById("prefSMS").checked,
          whatsapp: document.getElementById("prefWhatsApp").checked,
        };

        localStorage.setItem(
          `customerPrefs_${currentCustomerData.phone}`,
          JSON.stringify(prefs)
        );
        showNotification("Preferences saved successfully", "success");
      }

      // Open WhatsApp
      function openWhatsApp() {
        const phone = "966557485529";
        const message = encodeURIComponent(
          "Hello, I would like to inquire about tailoring services."
        );
        window.open(`https://wa.me/${phone}?text=${message}`, "_blank");
      }

      // Format date
      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "-";

        const options = { year: "numeric", month: "short", day: "numeric" };

        if (currentLang === "ar") {
          return date.toLocaleDateString("ar-SA", options);
        } else if (currentLang === "bn") {
          return date.toLocaleDateString("bn-BD", options);
        } else {
          return date.toLocaleDateString("en-US", options);
        }
      }

      // Get currency
      function getCurrency() {
        return currentLang === "ar"
          ? "ريال"
          : currentLang === "bn"
          ? "রিয়াল"
          : "SAR";
      }

      // Show notification
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `alert alert-${type}`;
        notification.innerHTML = `
                <i class="fas fa-${
                  type === "success"
                    ? "check-circle"
                    : type === "error"
                    ? "exclamation-circle"
                    : type === "warning"
                    ? "exclamation-triangle"
                    : "info-circle"
                }"></i>
                <span>${message}</span>
            `;

        let container = document.getElementById("notificationContainer");
        if (!container) {
          container = document.createElement("div");
          container.id = "notificationContainer";
          container.style.cssText =
            "position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;";
          document.body.appendChild(container);
        }

        container.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideUp 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }
    </script>
  </body>
</html>
